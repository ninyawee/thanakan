[tools]
python = "3.14.2"

[tasks.api]
description = "Run the statement API server (development)"
run = "uv run --package thanakan-statement-api uvicorn thanakan_statement_api.main:app --reload --port 8000"

[tasks."api:prod"]
description = "Run the statement API server (production)"
run = "uv run --package thanakan-statement-api uvicorn thanakan_statement_api.main:app --host 0.0.0.0 --port 8000"

[tasks.pypi]
description = "Publish all packages to PyPI"
depends = ["pypi:libs", "pypi:main"]

[tasks."pypi:libs"]
description = "Build and publish all workspace packages to PyPI"
run = """
#!/usr/bin/env bash
set -e

PUBLISH_URL=""
if [[ "${test:-}" == "true" ]]; then
  PUBLISH_URL="--publish-url https://test.pypi.org/legacy/"
  echo "ðŸ§ª Publishing to TestPyPI..."
fi

packages=(
  "packages/thanakan-qr"
  "packages/thanakan-oauth"
  "packages/thanakan-statement"
  "packages/thanakan-mail"
  "packages/thanakan-accounting"
)

for pkg in "${packages[@]}"; do
  echo "ðŸ“¦ Publishing $pkg..."
  cd "$MISE_PROJECT_ROOT/$pkg"
  rm -rf dist/
  uv build --out-dir dist/
  uv publish $PUBLISH_URL
  cd "$MISE_PROJECT_ROOT"
done

echo "âœ… All workspace packages published!"
"""

[tasks."pypi:main"]
description = "Build and publish main thanakan package to PyPI"
run = """
#!/usr/bin/env bash
set -e

PUBLISH_URL=""
if [[ "${test:-}" == "true" ]]; then
  PUBLISH_URL="--publish-url https://test.pypi.org/legacy/"
  echo "ðŸ§ª Publishing to TestPyPI..."
fi

echo "ðŸ“¦ Publishing thanakan (main package)..."
cd "$MISE_PROJECT_ROOT"
rm -rf dist/
uv build
uv publish $PUBLISH_URL

echo "âœ… Main package published!"
"""
